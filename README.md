# Сервис для работы с направленным ациклическим графом (DAG)

## Технический стек

- Язык: Python 3.11
- Фреймворк: FastAPI
- База данных: PostgreSQL 13
- ORM: SQLAlchemy 2.0+
- Контейнеризация: Docker + docker-compose
- Управление зависимостями: poetry
- Миграции: alembic
- Тесты: pytest

## Описание общих принципов работы сервиса

Этот сервис помогает хранить и управлять направленными ациклическими графами (DAG). Он принимает запросы,
обрабатывает их и возвращает данные о графах. Всё работает на Python 3.11 с использованием FastAPI, который быстро
отвечает
на запросы. Данные хранятся в базе PostgreSQL, а SQLAlchemy помогает с ними работать. Сервис запускается в
Docker-контейнерах, чтобы всё было просто настроить и запустить на любом компьютере. Когда кто-то делает запрос, сервис
идёт в БД, берёт нужные данные и отправляет их обратно.

### Основные ручки сервиса:

- **POST /api/graph/**  
  Создаёт новый граф. Нужно отправить данные в формате JSON с вершинами (nodes) и рёбрами (edges). Если всё ок, вернёт
  ID нового графа (код 201). Если данные плохие, выдаст ошибку 400 или 422 (проблемы с валидацией).

- **GET /api/graph/{graph_id}/**  
  Показывает граф по его ID. Просто вбей ID (например, 1) и получишь вершины и рёбра в JSON. Работает, если граф есть (
  код 200), иначе ошибка 404. Может быть 422, если ID кривой.

- **GET /api/graph/{graph_id}/adjacency_list**  
  Даёт список смежности для графа с указанным ID. Это пары: вершина — список её потомков. Если граф найден, вернёт
  результат (код 200), иначе 404. Ошибка 422 возможна при неверном ID.

- **GET /api/graph/{graph_id}/reverse_adjacency_list**  
  Показывает список смежности для траснспонированного графа с указанным ID — вершина и её предки в исходном графе.
  Работает с кодом 200, если граф есть, или 404, если нет. Ошибка 422 — если ID неправильный.

- **DELETE /api/graph/{graph_id}/node/{node_name}**  
  Удаляет вершину с заданным именем из графа по ID. Если удаление прошло, вернёт 204 (без тела). Если графа или вершины
  нет, ошибка 404. Неверные данные дадут 422.

## Решения принятые, за рамки требований

- Одно из решений вне требований это миграции, тут я использовал alembic.
- Для управления зависимостями я решил использовать poetry, гибкий, удобный инструмент, подойдёт и для хостинга и для
  локальной разработки. Можно конечно использовать venv, но poetry сильно приятнее.
- Ручка для удаления нод. Тут я задумался, а что если останется одна нода в графе и пользователь захочет её удалить (по
  условию в графе должен быть минимум одна нода). Было всего два очевидных возможных решения проблемы: вернуть ошибку
  или удалить граф весь. Ну я подумал что будто бы смысла в графе с одной нодой нет, так как рёбер там быть не может и
  единственная информация которую она хранит это имя и решил просто удалить граф весь.
-

## Как запустить сервис

1. Установите Docker и Docker Compose.
  
2. Сделайте копию файла .env.example и назовите её .env. Вставь туда
   свои данные:
    ```bash
   cp .env.example .env
   ```

    - имя пользователя базы (POSTGRES_USER)
    - пароль (POSTGRES_PASSWORD)
    - название базы (POSTGRES_DB)
    - порт (обычно 5432, пиши POSTGRES_PORT)
    - хост (обычно postgres,вообще должен совпадать с container_name из сервиса db в docker-compose)
    - строку подключения писать НЕ нужно код сам собирает эту строку из переменных окружения

3. Запустите в папке проекта команду для сборки докер компоуз:
   ```bash
   docker-compose up --build
   ```
4. Откройте в браузер http://localhost:8080/swagger там будет документация, можно подёргать ручки.

## Как запустить тесты

Тесты запускаются тоже в докере, это чтобы вы не парились с зависимостями и чтобы всё работало наверняка.

1. все этапы из раздела ["Как запустить сервис"](#как-запустить-сервис):
2. Зайдите в контейнер, запустите команду в директории проекта чтобы зайти в контейнер:
   ```bash
   docker exec -it dag-service /bin/bash
   ```
3. Запустить тесты:
   ```bash
   poetry run pytest tests/ -v
   ```
4. Чтобы увидеть покрытие тестами:
   ```bash
   poetry run pytest tests/ -v --cov=dag_service --cov-report html --cov-fail-under=80
   ```
   (Отчёты будут в директории pytest-cov-report как и внутри контейнера, так и в директории проекта на хосте)
